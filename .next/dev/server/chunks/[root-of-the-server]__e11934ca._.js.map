{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/chiio/VSCode/wedd-inv/app/api/upload/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\n\nexport async function POST(req: NextRequest) {\n  const SUPABASE_URL = process.env.SUPABASE_URL\n  const SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY\n  const BUCKET = process.env.NEXT_PUBLIC_SUPABASE_BUCKET || 'wedding-assets'\n\n  if (!SUPABASE_URL || !SERVICE_KEY) {\n    return new Response(JSON.stringify({ success: false, error: 'Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY on server.' }), { status: 500 })\n  }\n\n  try {\n    const form = await req.formData()\n    const file = form.get('file') as File | null\n    const filenameRaw = (form.get('filename') as string) || (file && (file as any).name) || `upload-${Date.now()}`\n    // sanitize filename: remove unsafe characters (spaces, brackets, unicode, etc.)\n    const filename = String(filenameRaw)\n      .trim()\n      .replace(/\\s+/g, '-') // spaces -> hyphen\n      .replace(/[^a-zA-Z0-9.\\-_]/g, '-') // remove other unsafe chars\n      .replace(/-+/g, '-')\n    const folder = (form.get('folder') as string) || 'wedding'\n\n    if (!file || typeof file === 'string') {\n      return new Response(JSON.stringify({ success: false, error: 'No file provided' }), { status: 400 })\n    }\n\n    const arrayBuffer = await file.arrayBuffer()\n    const buffer = Buffer.from(arrayBuffer)\n    let uploadBuffer = buffer\n    let contentType = file.type || 'application/octet-stream'\n\n    // If the uploaded file is an image, try to re-encode it server-side to avoid\n    // progressive JPEGs or other formats that cause rendering quirks in some browsers.\n    if (file.type && file.type.startsWith('image/')) {\n      try {\n        const sharp = await import('sharp')\n        // For PNG keep PNG output; for other images, convert to baseline JPEG\n        if (file.type === 'image/png') {\n          uploadBuffer = await sharp.default(buffer).png({ compressionLevel: 9 }).toBuffer()\n          contentType = 'image/png'\n        } else {\n          // Convert to non-progressive JPEG to avoid progressive rendering seams\n          uploadBuffer = await sharp.default(buffer).jpeg({ quality: 90, progressive: false }).toBuffer()\n          contentType = 'image/jpeg'\n        }\n      } catch (e) {\n        // If sharp is not available or conversion fails, fall back to original buffer\n        // but continue â€” upload will proceed with original content-type.\n        console.warn('Image re-encoding failed, uploading original file:', String(e))\n        uploadBuffer = buffer\n        contentType = file.type || 'application/octet-stream'\n      }\n    }\n    const path = `${folder}/${Date.now()}-${filename}`\n\n    const supabase = createClient(SUPABASE_URL, SERVICE_KEY, {\n      auth: { persistSession: false },\n    })\n\n    const { error } = await supabase.storage.from(BUCKET).upload(path, uploadBuffer, {\n      contentType,\n      upsert: false,\n    })\n\n    if (error) {\n      return new Response(JSON.stringify({ success: false, error: error.message }), { status: 400 })\n    }\n\n    const { data } = supabase.storage.from(BUCKET).getPublicUrl(path)\n\n    return new Response(JSON.stringify({ success: true, publicUrl: data.publicUrl }), { status: 200 })\n  } catch (err: any) {\n    return new Response(JSON.stringify({ success: false, error: String(err) }), { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AACA;;AAEO,eAAe,KAAK,GAAgB;IACzC,MAAM,eAAe,QAAQ,GAAG,CAAC,YAAY;IAC7C,MAAM,cAAc,QAAQ,GAAG,CAAC,yBAAyB;IACzD,MAAM,SAAS,QAAQ,GAAG,CAAC,2BAA2B,IAAI;IAE1D,IAAI,CAAC,gBAAgB,CAAC,aAAa;QACjC,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;YAAE,SAAS;YAAO,OAAO;QAA+D,IAAI;YAAE,QAAQ;QAAI;IAC/I;IAEA,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,QAAQ;QAC/B,MAAM,OAAO,KAAK,GAAG,CAAC;QACtB,MAAM,cAAc,AAAC,KAAK,GAAG,CAAC,eAA2B,QAAQ,AAAC,KAAa,IAAI,IAAK,CAAC,OAAO,EAAE,KAAK,GAAG,IAAI;QAC9G,gFAAgF;QAChF,MAAM,WAAW,OAAO,aACrB,IAAI,GACJ,OAAO,CAAC,QAAQ,KAAK,mBAAmB;SACxC,OAAO,CAAC,qBAAqB,KAAK,4BAA4B;SAC9D,OAAO,CAAC,OAAO;QAClB,MAAM,SAAS,AAAC,KAAK,GAAG,CAAC,aAAwB;QAEjD,IAAI,CAAC,QAAQ,OAAO,SAAS,UAAU;YACrC,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAmB,IAAI;gBAAE,QAAQ;YAAI;QACnG;QAEA,MAAM,cAAc,MAAM,KAAK,WAAW;QAC1C,MAAM,SAAS,OAAO,IAAI,CAAC;QAC3B,IAAI,eAAe;QACnB,IAAI,cAAc,KAAK,IAAI,IAAI;QAE/B,6EAA6E;QAC7E,mFAAmF;QACnF,IAAI,KAAK,IAAI,IAAI,KAAK,IAAI,CAAC,UAAU,CAAC,WAAW;YAC/C,IAAI;gBACF,MAAM,QAAQ;gBACd,sEAAsE;gBACtE,IAAI,KAAK,IAAI,KAAK,aAAa;oBAC7B,eAAe,MAAM,MAAM,OAAO,CAAC,QAAQ,GAAG,CAAC;wBAAE,kBAAkB;oBAAE,GAAG,QAAQ;oBAChF,cAAc;gBAChB,OAAO;oBACL,uEAAuE;oBACvE,eAAe,MAAM,MAAM,OAAO,CAAC,QAAQ,IAAI,CAAC;wBAAE,SAAS;wBAAI,aAAa;oBAAM,GAAG,QAAQ;oBAC7F,cAAc;gBAChB;YACF,EAAE,OAAO,GAAG;gBACV,8EAA8E;gBAC9E,iEAAiE;gBACjE,QAAQ,IAAI,CAAC,sDAAsD,OAAO;gBAC1E,eAAe;gBACf,cAAc,KAAK,IAAI,IAAI;YAC7B;QACF;QACA,MAAM,OAAO,GAAG,OAAO,CAAC,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,UAAU;QAElD,MAAM,WAAW,IAAA,4SAAY,EAAC,cAAc,aAAa;YACvD,MAAM;gBAAE,gBAAgB;YAAM;QAChC;QAEA,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,OAAO,CAAC,IAAI,CAAC,QAAQ,MAAM,CAAC,MAAM,cAAc;YAC/E;YACA,QAAQ;QACV;QAEA,IAAI,OAAO;YACT,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;gBAAE,SAAS;gBAAO,OAAO,MAAM,OAAO;YAAC,IAAI;gBAAE,QAAQ;YAAI;QAC9F;QAEA,MAAM,EAAE,IAAI,EAAE,GAAG,SAAS,OAAO,CAAC,IAAI,CAAC,QAAQ,YAAY,CAAC;QAE5D,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;YAAE,SAAS;YAAM,WAAW,KAAK,SAAS;QAAC,IAAI;YAAE,QAAQ;QAAI;IAClG,EAAE,OAAO,KAAU;QACjB,OAAO,IAAI,SAAS,KAAK,SAAS,CAAC;YAAE,SAAS;YAAO,OAAO,OAAO;QAAK,IAAI;YAAE,QAAQ;QAAI;IAC5F;AACF"}}]
}